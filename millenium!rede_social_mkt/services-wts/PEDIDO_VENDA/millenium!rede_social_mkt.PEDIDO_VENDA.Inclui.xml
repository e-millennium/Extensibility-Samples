<?xml version="1.0"?>
<root>
  <OBJECT NAME="PEDIDO_VENDA">
    <METHOD NAME="Inclui" DESCRIPTION="" VERSION="60" INTFTYPE="1" TRIGGEROF="PEDIDO_VENDA.INCLUI" TRIGGERTYPE="0" THREADSAFE="0">
      <PARAMS>
        <GROUPS>
          <GROUP/>
        </GROUPS>
        <PARAM NAME="RSM_NUMERO_CUPOM" SIZE="50" FLAGS="1" PROJECTION="0" ORDER="1" LOOKUP="CAMPANHAS.LISTA" LOOKUPKEY="NUMERO_CUPOM" LOOKUPDISPLAY="DESCRICAO" LOOKUPCODE="NUMERO_CUPOM" FIELDLABEL="N&#250;mero Cupom Rede Social" CTAB="0"/>
        <PARAM NAME="RSM_PERCENTUAL_DESCONTO" FORMAT="N" SIZE="8" FLAGS="131" VISIBILITYRULE="RSM_NUMERO_CUPOM&lt;>''" PROJECTION="0" ORDER="2" FIELDLABEL="M&#225;ximo de Desconto %" CTAB="0"/>
      </PARAMS>
      <FIELDS/>
      <ACTIONSCRIPT>#SELECT((RSM_NUMERO_CUPOM=""),TRUE:{},ELSE:{#CHECK("SELECT COUNT(*) AS N FROM RSM_CAMPANHAS WHERE NUMERO_CUPOM=:RSM_NUMERO_CUPOM",N=0,"N&#250;mero Cupom inv&#225;lido!");

                                            #CHECK("SELECT COUNT(*) AS N FROM RSM_CAMPANHAS WHERE NUMERO_CUPOM=:RSM_NUMERO_CUPOM AND #DATE() BETWEEN DATA_INICIAL AND DATA_FINAL",N=0,"Cupom fora de validade!");
                                            
                                            #CHECK("SELECT COUNT(*) FROM PEDIDO_VENDA PV INNER JOIN RSM_PEDIDO_VENDA RSMPV ON (RSMPV.PEDIDOV=:PEDIDOV) WHERE PV.CLIENTE = (SELECT CLIENTE FROM PEDIDO_VENDA PV WHERE PV.PEDIDOV=:WTSSYS_OBJECT) AND RSMPV.NUMERO_CUPOM=:RSM_NUMERO_CUPOM",N>1,"Cupom j&#225; utilizado por este cliente!");

                                            SELECT:CAM CAMPANHA FROM RSM_CAMPANHAS WHERE NUMERO_CUPOM=:RSM_NUMERO_CUPOM;
                                            
                                            INSERT INTO RSM_PEDIDO_VENDA(PEDIDOV,NUMERO_CUPOM,CAMPANHA) VALUES(:WTSSYS_OBJECT,:RSM_NUMERO_CUPOM,:CAM.CAMPANHA);
                                           });

</ACTIONSCRIPT>
    </METHOD>
  </OBJECT>
</root>